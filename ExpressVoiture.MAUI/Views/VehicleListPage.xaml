<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:ExpressVoiture.MAUI.ViewModels"
             xmlns:shared="clr-namespace:ExpressVoiture.Shared.ViewModel;assembly=ExpressVoiture.Shared"
             x:Class="ExpressVoiture.MAUI.Views.VehicleListPage"
             x:DataType="viewmodel:VehicleListViewModel"
             Title="Nos véhicules">

    <StackLayout Padding="10" Spacing="10">

        <!-- Barre supérieure -->
        <Grid Padding="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Label Text="Nos véhicules" FontSize="24" FontAttributes="Bold" VerticalOptions="Center" />

            <!-- Bouton Administration -->
            <Button Grid.Column="1" 
                    Text="Administration" 
                    Command="{Binding GoToAdminCommand}" 
                    IsVisible="{Binding IsLoggedIn}" 
                    Margin="0,0,10,0" />

            <!-- Bouton Connexion/Déconnexion -->
            <Button Grid.Column="2" 
                    Text="{Binding LoginButtonText}" 
                    Command="{Binding ToggleLoginCommand}" />
        </Grid>

        <!-- Loader -->
        <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" HorizontalOptions="Center" />

        <!-- Liste des véhicules -->
        <CollectionView ItemsSource="{Binding Vehicles}" SelectionMode="Single" 
                SelectedItem="{Binding SelectedVehicle, Mode=TwoWay}"
                SelectionChanged="CollectionView_SelectionChanged">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="shared:ClientVehicleListDto">
                    <Frame CornerRadius="10"
                           BorderColor="#CCCCCC"
                           Padding="10"
                           Margin="0,0,0,10"
                           BackgroundColor="White"
                           HasShadow="True">

                        <!-- TapGestureRecognizer pour rendre la Frame cliquable -->
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:VehicleListViewModel}}, Path=VehicleSelectedCommand}"
                                                  CommandParameter="{Binding .}" />
                        </Frame.GestureRecognizers>

                        <Grid ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="120" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- Image du véhicule -->
                            <Image Source="{Binding ImagePath}" 
                                   WidthRequest="100" 
                                   HeightRequest="80" 
                                   Aspect="AspectFill" />

                            <!-- Informations du véhicule -->
                            <StackLayout Grid.Column="1" Spacing="5">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Label Text="{Binding Marque}" FontAttributes="Bold" FontSize="16" Grid.Column="0"/>
                                    <Label Text="{Binding PrixVente, StringFormat='Prix: {0} €'}" Grid.Column="1" TextColor="Red" FontAttributes="Bold"/>
                                </Grid>

                                <Label Text="{Binding Modele, StringFormat='Modèle: {0}'}" FontSize="14" TextColor="#555555"/>
                                <Label Text="{Binding Annee, StringFormat='Année: {0}'}" FontSize="14" TextColor="#555555"/>
                                <Label Text="{Binding Finition, StringFormat='Finition: {0}'}" FontSize="14" TextColor="#555555"/>

                                <Label Text="{Binding DateVente, StringFormat='Vendu le: {0:dd/MM/yyyy}'}" FontSize="12" TextColor="#777777" IsVisible="{Binding DateVente, Converter={StaticResource NullToBoolConverter}}"/>
                            </StackLayout>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

    </StackLayout>
</ContentPage>
